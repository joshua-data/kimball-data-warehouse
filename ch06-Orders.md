### ■ 다루는 주요 주제

1. 주문관리 버스 매트릭스
2. 주문 트랜잭션 스키마
3. 팩트 테이블 정규화 여부
4. 롤 플레잉 디멘션
5. 배송처/청구처 고객 디멘션 설계
6. 단일 vs 다중 디멘션 선택 기준
7. 정크 디멘션 vs 대체 설계
8. 퇴화 디멘션 상세
9. 다중 통화/측정 단위 고려
10. 서로 다른 그래뉼래러티 처리
11. 헤더/라인 패턴 회피
12. 송장 트랜잭션과 손익 팩트
13. 감사 디멘션
14. 서비스 수준 지표 설계
15. 점진적 스냅샷
16. 시간 차이 계산

---

### ■ 주문관리 버스 매트릭스

- 버스 매트릭스는 프로세스 간 관계와 참여 디멘션을 구조적으로 시각화함
- 주문처리 단계: 견적 → 주문 → 배송 → 송장 → 수금 → 반송
- 각 프로세스별 KPI 정의 및 추적 용이

---

### ■ 주문 트랜잭션 팩트 테이블

- 각 주문의 **라인 항목**이 팩트 테이블의 한 row
- 디멘션: 주문 일자, 배송 요청 일자, 제품, 고객, 영업담당자, 거래 등
- 팩트: 수량, 주문 금액, 할인 금액, 순 금액 등
- 주문번호, 라인번호 → **퇴화 디멘션(Degenerate Dimension)** 으로 관리

---

### ■ 팩트 테이블 정규화에 대한 고찰

- ❌ 팩트 테이블을 정규화하는 것은 일반적으로 비효율적임
    - 팩트 유형별로 row를 나누면 데이터가 폭발적으로 증가
    - 서로 다른 row에 있는 팩트 간 연산이 어려움 (예: 주문금액 대비 할인율)
- ✅ 하나의 row에 모든 관련 팩트를 포함하는 것이 일반적인 설계 방식

---

### ■ 롤 플레잉 디멘션

- 동일한 디멘션 테이블을 다양한 역할로 사용 (예: 주문일자 vs 배송요청일자)
- 물리적으로는 하나의 테이블, 논리적으로는 별칭 혹은 뷰를 통해 분리
- 각 뷰에는 유일한 컬럼 이름을 사용해야 충돌 방지 가능

---

## 📦 제품 디멘션 (Product Dimension)

### ✅ 제품 디멘션의 중요성

- 대부분의 사례 연구에서 **제품 디멘션은 공통적으로 등장**하며, 가장 일반적이고 중요한 디멘션 테이블 중 하나이다.
- 기업에서 판매되는 **모든 제품 포트폴리오를 설명**한다.
- 일부 제조업체는 **수만~수백만 개**의 제품을 보유하고 있음.

### 🔍 제품 디멘션의 일반적인 특성

1. **다수의 상세 속성 (Descriptive Attributes)**
    - 수십~수백 개의 속성이 존재할 수 있음.
    - 대부분 속성은 시간이 지나도 변하지 않음 (Slowly Changing 가능성은 있음).
2. **계층과 비계층 속성 공존**
    - 예: 제품 → 브랜드 → 카테고리
    - **계층은 반정규화하여 하나의 테이블에 포함**해야 함. → 성능과 단순화를 위해 스노우플레이크는 지양.
3. **필터링 기반 UI의 필요성**
    - 속성이 많고 로우 수가 크므로 **속성 기반 필터링 UI**가 필수.
    - 예: '맛' → '치킨' 선택 후, '패키지 타입' 필터링 가능
4. **속성은 자유롭게 드릴업/드릴다운 가능해야 함**
    - 계층 여부와 관계없이 속성은 분석에 유연하게 활용되어야 함.

---

### ⚙️ 운영계 제품 마스터에서 디멘션 테이블 생성 시 고려사항

1. **형제 제품 코드 → 대체 키로 재매핑**
    - 운영계에서 동일한 코드가 중복될 수 있으므로, **Surrogate Key 필요**
    - Type 2 변경 추적, 이질적인 소스 통합에도 Surrogate Key 필수
2. **암호처럼 생긴 코드 → 읽기 쉬운 텍스트로 변환**
    - 코드 중심의 속성은 **사용자 친화적인 이름으로 변환**
    - 여러 개의 축약된 코드를 한 컬럼에 포함하지 않고 분리해야 함
3. **데이터 품질 관리**
    - 철자 오류, NULL, 다양한 철자 변형 방지
    - 속성 값이 SQL Grouping에 영향을 줄 수 있으므로 정확한 값이 필요
4. **메타 데이터 기록**
    - 속성의 정의, 출처, 해석을 메타 데이터에 기록
    - DW/BI 백과사전의 역할 → 사용자 혼란 방지

---

## 👥 고객 디멘션 (Customer Dimension)

### ✅ 고객 디멘션 개요

- **배송처 기준**으로 한 로우를 가짐
- 규모: 수천~수백만 로우까지 다양
- 예시 속성: 고객명, 주소, 도시, 주, 우편번호 등

### 🌍 독립적인 계층 구조

1. **지리적 계층**
    - 도시 → 카운티 → 주 등으로 구성
    - 동일한 도시명이 여러 주에 존재하므로 **도시-주 조합** 유용
    - 우편번호 → 첫 숫자: 지역 / 첫 3자리: 중앙 집배소
2. **조직 계층**
    - 배송처 → 청구처 → 모법인
    - 배송처와 청구처가 다대일 관계

### 🧩 고객 디멘션의 유연한 계층 구조

- 한 디멘션에 **여러 개의 독립 계층이 존재 가능**
- 매우 일반적이며 특히 고객 디멘션에서 두드러짐

---

### ⚠️ 주의사항

- **배송처 ↔ 청구처** 관계가 단순하지 않을 수 있음
- 현실적으로 배송처가 **여러 청구처와 관련될 수 있음**
- 이 경우에는 **배송처-청구처 조합**을 하나의 로우로 구성해야 할 수도 있음 (복합키 방식)

---

## ✅ 1. 정크 디멘션(Junk Dimension)이란?

### 📌 정의

- **낮은 카디널리티**를 가지는 **플래그(flag)**와 **분류 값(attributes)**들을 하나의 디멘션으로 묶은 것
- 일종의 ‘**잡동사니 서랍**’처럼, 자잘한 정보들을 별도로 관리하는 구조

### 🧩 예시

- 지불 유형(현금/신용카드), 주문 유형(인바운드/아웃바운드), 커미션 여부(가능/불가능) 등의 속성들

---

## ✅ 2. 낮은 카디널리티 속성 처리의 4가지 기존 방법 (비추천)

| 방법 | 설명 | 한계 |
| --- | --- | --- |
| ① 무시 | 분석 가치가 작아 보여 제거 | 일부 사용자에게는 유용할 수 있음 |
| ② 팩트 테이블에 그대로 둠 | 텍스트를 직접 팩트에 저장 | 테이블 커짐, 읽기 어려움 |
| ③ 각각 디멘션화 | 속성마다 디멘션 만들기 | 외래키 증가, 관리 복잡 |
| ④ 주문 헤더 디멘션에 넣기 | 속성을 정규 디멘션으로 통합 | 데이터 표현은 정확하나 비효율적 |

---

## ✅ 3. 정크 디멘션의 장점

- 자잘한 속성을 **하나의 디멘션으로 통합**
- 팩트 테이블에는 **작은 대체 키**만 저장하여 **공간 절약**
- 리포트 필터나 제한 조건으로 활용 가능

### 💡 예시 조합

- 속성 10개 × 각각 2개 값 → 최대 2¹⁰ = **1,024개 조합의 디멘션 로우**
- 현실 조합 수는 적으므로 **필요한 조합만 생성 (on-demand 방식)** 사용

---

## ✅ 4. 정크 디멘션 설계 시 주의사항

| 상황 | 설계 제안 |
| --- | --- |
| 속성 간 연관성 없고 값 종류가 많을 때 | 정크 디멘션 ❌, 별도 디멘션 권장 |
| 속성 간 연관성 있고 값 종류가 적을 때 | 정크 디멘션 ✅ |

> 예: 5개의 속성 × 각 3개 값 → 3⁵ = 243개 → 정크 디멘션 적합
> 
> 
> 반면, 5개의 속성 × 각 100개 값 → 100⁵ = 1억 → ❌
> 

---

## ✅ 5. 정크 디멘션 vs. 주문 헤더 디멘션

| 항목 | 정크 디멘션 사용 시 | 주문 헤더 디멘션 사용 시 |
| --- | --- | --- |
| 조회 방식 | 플래그 키로 바로 필터 | 주문번호 리스트 만들고 조건 걸어야 함 |
| 장점 | 간단하고 빠름 | 데이터 관계 명확하게 표현 가능 |
| 단점 | 조합 수 많으면 비효율 | 조회 시 Join 연산 증가 |

---

## ✅ 6. 회피해야 할 헤더/라인 모델링 패턴

### ❌ 잘못된 설계 예시

- 운영계 주문 헤더 테이블을 거의 **복제하여 디멘션으로 사용**
- 헤더 디멘션이 너무 많은 정보를 가짐 → **디멘션 역할 흐려짐**
- 주문번호를 디멘션 키로 사용함 → **팩트와의 관계가 모호해짐**

### ✅ 올바른 접근

- **주문 라인 항목 단위**로 팩트 테이블을 구성
- 설명 항목은 필요한 만큼만 디멘션으로 분리하여 설계

---

## 💱 다중 통화(Multi-Currency) 문제

### 📌 배경

- 미국 본사 + 다국적 영업 사무소 → 하나의 **글로벌 주문 시스템**
- 주문 시 사용되는 통화가 다양함 (예: KRW, USD, EURO 등)

### 🎯 요구 사항

- 모든 주문 데이터를 **두 가지 통화 기준**으로 조회 가능해야 함
    - **로컬 통화 (Transaction Currency)**
    - **법인 기준 통화 (Corporate Currency, 예: USD)**

---

## 📐 설계 전략

### ✅ 팩트 테이블 구조

**주문 라인 팩트 테이블**에 다음 컬럼 추가:

| 컬럼 | 설명 |
| --- | --- |
| 로컬 통화 디멘션 키 | 트랜잭션이 사용한 통화 종류 (예: KRW, EUR) |
| USD 주문 라인 총 금액 | 법인 통화 기준 금액 |
| 로컬 통화 주문 라인 총 금액 | 실제 발생 금액 |
| USD/로컬 통화 할인/순금액 | 각각 포함됨 |

> 📌 이중 금액 보관 → 롤업 계산이 쉬워짐 + 리포트 앱에서 환율 계산 안 해도 됨
> 

### ✅ 통화 디멘션 예시

| 컬럼명 | 설명 |
| --- | --- |
| 로컬 통화 키 (PK) |  |
| 로컬 통화명 | 대한민국 원, 미국 달러 등 |
| 로컬 통화 약어 | KRW, USD, EUR 등 |

---

## 🔄 환율 관리: 통화 변환 팩트 테이블

### ✅ 통화 변환 팩트 구조 (그림 6-11)

| 컬럼 | 설명 |
| --- | --- |
| 변환 일자 키 | 환율 기준 일자 |
| 소스 통화 키 | 변환 전 통화 |
| 타깃 통화 키 | 변환 대상 통화 |
| 소스 → 타깃 환율 | ex) KRW → USD |
| 타깃 → 소스 환율 | ex) USD → KRW |

> 양방향 환율 필요: 방향에 따라 환율이 다르기 때문
> 

### ✅ 관리 포인트

- 전 세계 100여 개 통화 X 100 조합 = 10,000개 불필요
- 실무에서는 실제 사용하는 주요 통화 조합만 관리

---

## 📌 추가 팩트 설계 예시

| 사례 | 설명 |
| --- | --- |
| 지역 센터 표준 통화 | 로컬 + USD 외에 제 3의 통화 추가 가능 |
| 고객 배송처 통화 | 배송지나 청구처 기준 통화로 환산 가능 |
| 견적/선적 통화 | 견적서나 송장에 쓰인 통화 기준도 필요할 수 있음 |

---

## 📊 헤더 → 라인 팩트 배부

### 📌 왜 배부해야 하나?

- 헤더 팩트(배송비 등)가 주문 라인마다 안 나눠지면, 제품 기준 분석이 불가능함
- 제품별, 고객별 분석이 쉬워지도록 **라인 수준으로 팩트를 내리는 것**이 중요

### 🛠️ 배부 예시 (그림 6-12)

| 팩트 수준 | 배부 전 | 배부 후 |
| --- | --- | --- |
| 헤더 팩트 | 주문 배송비 | 라인마다 분배된 배송비 |
| 팩트 구조 | 주문번호 (PK), 배송비 | 주문번호 + 라인번호 + 배송비 |

> 배부된 배송비 금액은 주문 라인 수량 또는 금액 기준으로 나눌 수 있음
> 

---

## ⚠️ 배부의 조직적 문제

### ❗ 이슈

- 헤더를 라인으로 어떻게 나눌지는 **재무 부서의 민감한 이슈**
- DW/BI 팀이 배부 방식 결정하면 **정치적 논쟁**에 휘말릴 수 있음

### ✅ 권장 접근

- 배부 규칙은 **조직 내 공식 정책**으로 확정되어야 함 (예: 활동 기준 원가관리)
- DW/BI 팀은 배부 로직이 정해진 후 **기술적 구현만 담당**

---

## ✅ 요약 정리

| 항목 | 내용 |
| --- | --- |
| 다중 통화 설계 | 로컬 통화 + 법인 통화 모두 저장 |
| 환율 관리 | 통화 변환 팩트 테이블 사용 (양방향 환율) |
| 헤더 팩트 배부 | 슬라이스 앤 다이스를 위한 필수 절차 |
| 조직적 고려 | 배부 기준은 재무팀, DW는 구현만 담당 |

---

## 1️⃣ 회피해야 할 헤더/라인 패턴

### ❗ 잘못된 설계 패턴 예시 (그림 6-13)

- **문제**: 주문 헤더를 디멘션 대신 별도 팩트 테이블로 구성 → 라인 팩트에서 상속하지 않음
- **구성**:
    - `주문 헤더 트랜잭션 팩트`: 주문 단위로 요약된 정보 보유
    - `주문 라인 트랜잭션 팩트`: 라인별 상세 정보 보유
- **문제점 요약**:
    - 분석 시 **거대한 테이블끼리 조인** 발생 → 성능 저하
    - **헤더와 라인 간 상속 단절**로 인해 통합 분석이 어려움

> ✅ 권장 설계: 헤더 정보는 라인 팩트 테이블에서 상속하거나, 디멘션으로 참조되도록 구성
> 

---

## 2️⃣ 송장 트랜잭션 팩트 테이블 설계

### 💡 기본 개념

- **정의**: 고객에게 실제 배송 시점에 발행되는 송장을 중심으로 수집되는 트랜잭션 데이터
- **핵심 포인트**:
    - 다양한 **가격/비용/수익 지표** 포함
    - 제조, 물류, 서비스 수준, 고객 만족 등 다양한 **분석 포인트** 제공

---

### 📊 그림 6-14: 송장 라인 트랜잭션 팩트 테이블 구조

| 항목 | 설명 |
| --- | --- |
| **그레인** | 개별 송장 라인 (하나의 송장 내 제품 한 건) |
| **디멘션 (FK)** | 고객, 제품, 영업 담당자, 거래, 창고, 운송사, 서비스 수준 등 |
| **일자 디멘션 (롤 플레잉)** | 송장 일자, 배송 요청 일자, 실제 배송 일자 |
| **퇴화 디멘션** | 송장번호, 송장 라인번호 |
| **측정값 (팩트)** | 수량, 총 금액, 수당, 할인, 순 금액, 고정 제조비, 변동 제조비, 창고비, 물류비, 공헌 금액 등 |
| **서비스 수준 관련 팩트** | 정시 배송 여부(0/1), 배송 시간 차이(day 단위) |

---

### 🧠 서비스 수준 표현 방법 (그림 6-15)

- **정량적 표현**: 팩트 필드 (정시 배송 카운터, 시간 차이 등)
- **정성적 표현**: 별도 디멘션 생성 또는 정크 디멘션 내 속성으로 추가

| 서비스 수준 키 | 설명 | 그룹 |
| --- | --- | --- |
| 1 | 정시의 | 정시 |
| 2 | 1일 이른 | 정시 이른 |
| 3 | 2일 이른 | 이른 |
| 4 | 3일 이른 | 이른 |
| 5 | 4일 이상 이른 | 너무 이른 |
| 6 | 1일 늦은 | 늦은 |
| 7 | 2일 늦은 | 늦은 |
| 8 | 3일 늦은 | 늦은 |
| 9 | 4일 이상 늦은 | 너무 늦은 |

---

## 3️⃣ 손익 팩트 (P&L 관련 분석)

- **전제**: ABC(Activity Based Costing) 또는 ERP 시스템이 갖춰진 경우 활용 가능
- **공헌 금액** (Contribution Margin): 수익에서 고정/변동 비용을 제외한 실제 기여 이익
- **팩트 컬럼 예시**:
    - 배송 수량
    - 총 금액 (=수량 x 장부 가격)
    - 할인 금액
    - 수당
    - 순 매출
    - 제조비(고정/변동), 창고비, 물류비
    - 공헌 금액 (총 수익 - 총 비용)

---

## ✅ 핵심 요약

| 구분 | 설명 |
| --- | --- |
| **좋은 설계** | 주문 헤더 정보를 라인 팩트에서 **상속**하거나 **디멘션화** |
| **송장 팩트** | 다양한 디멘션과 일자 기반, 수익 및 비용 요소 모두 포함 |
| **서비스 수준** | 정량 & 정성 지표를 **팩트** 또는 **디멘션**으로 표현 |
| **공헌 분석** | 손익 계산을 위한 각종 비용/수익 측정값을 별도로 관리 |

---

## 1. 🧾 감사 디멘션 (Audit Dimension)

### 📌 개념 요약

- **감사 디멘션**은 팩트 테이블에 로우가 적재될 때 생성되는 **ETL 메타데이터**를 관리하는 디멘션.
- 일반적으로는 **ETL 개발자와 IT 관리자**가 관심을 가지지만, **비즈니스 사용자도 신뢰성과 관련해 활용**하는 경우가 있다.

### ❓ 사용자가 던질 수 있는 질문

- 이 리포트의 수치는 신뢰할 수 있는가?
- 이상값이 있는가?
- 어떤 버전의 로직/환율이 사용되었는가?

### ✅ 구성 요소 예시

- 품질 분류값 (예: 정상/비정상)
- 한도 이탈 분류값
- 금액 조정 플래그
- 비용 배부 버전
- 외화 변환 버전

### 🧱 테이블 구조 예시

```
감사 디멘션
- 감사 키 (PK)
- 품질 분류값
- 한도 이탈 분류값
- 금액 조정 플래그
- 비용 배부 버전
- 외화 변환 버전

```

### 📈 활용 사례

- **송장 리포트에서 이상값 필터링**: 표준 리포트에 '한도이탈 분류값'을 추가해 정상/비정상 구분.
- **정책 변경 영향 분석**: 어떤 버전의 비용/환율 정책이 적용되었는지 리포트 기준 확인 가능.

---

## 2. 🔁 주문처리 점진적 스냅샷 (Accumulating Snapshot Fact Table)

### 📌 개념 요약

- **주문처리 과정의 마일스톤별 상태 변화**를 시간 흐름에 따라 누적해서 기록하는 스냅샷 팩트 테이블.
- 하나의 레코드에서 **여러 날짜 컬럼으로 마일스톤 상태 추적**이 가능.

### 🚚 파이프라인 예시 (그림 6-18)

```
주문 → 백로그 → 생산지시 → 완제품 창고 입고 → 배송 요청 → 배송 예정 → 실제 배송 → 송장

```

### 🧾 점진적 스냅샷 구조 예시

```
주문처리 점진적 스냅샷 팩트
- 주문 키
- 주문일자 키 (FK)
- 백로그일자 키 (FK)
- 생산지시일자 키 (FK)
- 창고입고일자 키 (FK)
- 배송요청일자 키 (FK)
- 배송예정일자 키 (FK)
- 실제배송일자 키 (FK)
- 송장발행일자 키 (FK)
- 고객 키, 거래 키, 제품 키 등 디멘션 키들

```

### ✅ 활용 목적

- **파이프라인의 속도 분석**: 주문에서 배송까지 얼마나 걸렸는지.
- **주문 현황 모니터링**: 현재 어떤 주문이 어떤 단계에 있는지.
- **병목구간 식별**: 특정 단계에서 평균 소요시간이 긴 지점 파악.

### 🔧 주의사항

- 처음 로우 적재 시 일부 일자 값이 아직 정해지지 않음 → 일자 디멘션에 "Unknown", "TBD" 등 특수 값 필요.
- 점진적 스냅샷은 **정기적으로 업데이트되는 ETL 작업이 필수**.

---

## 🔍 비교 요약

| 항목 | 감사 디멘션 | 점진적 스냅샷 |
| --- | --- | --- |
| 주요 목적 | ETL 메타데이터 기록 및 리포트 투명성 확보 | 프로세스 상태 추적 및 병목 분석 |
| 속성 유형 | 데이터 품질, 정책 버전 등 | 마일스톤 일자 |
| 활용 대상 | 기술자 & 일부 비즈니스 유저 | 비즈니스 전반 |
| 적재 방식 | ETL 중 특정 조건에 따라 디멘션 연결 | 상태 업데이트 시 갱신 |
| ETL 복잡도 | 중간 (버전, 품질 등 관리 필요) | 높음 (주기적 갱신 필요) |

---

## ✨ 실무 적용 팁

- **감사 디멘션은 처음부터 준비하지 않아도 되지만**, 리포트 신뢰도 문제가 생기면 반드시 필요해짐.
- **점진적 스냅샷은 초기 설계가 복잡하지만**, 프로세스 기반 분석에는 없어서는 안 될 구조.
- ETL 설계 시 **버전 관리와 상태 추적을 위한 설계 기준을 명확히** 정리하고, 변경 이력 로깅 체계 구축을 추천.